name: Verificação de Commits

on:
  push:
    branches: [ '**' ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify-commits:
    name: Verificar commits
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Obter SHAs dos commits
        id: commits
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=${{ github.event.pull_request.base.sha }}
            HEAD=${{ github.event.pull_request.head.sha }}
            echo "Base da PR=$BASE head=$HEAD"
            shas=$(git rev-list $BASE..$HEAD)
          else
            if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
              shas=$(git rev-list ${{ github.sha }})
            else
              shas=$(git rev-list ${{ github.event.before }}..${{ github.sha }})
            fi
          fi
          echo "$shas" > shas.txt
          echo "shas<<EOF" >> $GITHUB_OUTPUT
          echo "$shas" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validar mensagens de commit com script
        run: |
          chmod +x ./scripts/validate-commit-msg.sh || true
          set -e
          shas=$(cat shas.txt)
          if [ -z "$shas" ]; then
            echo "Nenhum commit encontrado para validar." && exit 0
          fi
          for sha in $shas; do
            ./scripts/validate-commit-msg.sh "$sha" || exit 1
          done

      - name: Verificação de padrão (fallback)
        run: |
          pattern='^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\([a-z0-9._-]+\))?: .{1,150}$'
          invalid=0
          # Ler SHAs de shas.txt e validar o SUBJECT (primeira linha) de cada commit
          while IFS= read -r sha; do
            subject=$(git log -1 --format=%s "$sha")
            # Pular commits de merge e subjects vazios
            if [ -z "$subject" ] || echo "$subject" | grep -qi "^merge"; then
              echo "Pulando commit $sha (merge ou assunto vazio): $subject"
              continue
            fi
            echo "Verificando assunto: $subject"
            if ! echo "$subject" | grep -Eqi "$pattern"; then
              echo "INVÁLIDO: $subject"
              invalid=1
            fi
          done < shas.txt
          if [ "$invalid" -ne 0 ]; then
            echo "::error::Um ou mais commits não seguem o padrão Conventional Commits." && exit 1
          fi

      - name: Sucesso
        run: echo "Todos os assuntos de commit seguem o padrão."